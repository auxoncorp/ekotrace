# modality-probe-cli
Generate Modality Probe event definitions and declarations and
visualize a trace.

## Overview

The Modality Probe CLI can be used to generate manifests containing
metadata for your events and probes, and then can generate code for
their definitions from those manifests. It can also be used to export
a collected trace as Graphviz dot code.

## Getting Started

### Dependencies
The CLI requires a Rust toolchain. The recommended toolchain
management system for Rust is [Rustup](https://rustup.sh).

### Building
Once Rust is installed (don’t forget to follow directions about
setting up `$PATH`), clone this repository and use Cargo to build it
locally:

```shell
$ cd modality-probe/modality-probe-cli
$ cargo install --path .
```

This will deposit a file at
`modality-probe/target/release/modality-probe` that can be run
directly.

## Usage

```
Modality probe command line interface

USAGE:
	modality-probe <SUBCOMMAND>

FLAGS:
	-h, --help   	Prints help information
	-V, --version	Prints version information

SUBCOMMANDS:
	export      	Export a collected trace as a Graphviz dot file
	header-gen  	Generate Rust/C header files with event/probe id constants
	help        	Prints this message or the help of the given subcommand(s)
	manifest-gen	Generate component, event and probe manifest files from probe macro invocations

```

### Export
```
modality-probe-export 0.3.0
Export a collected as a Graphviz dot file

USAGE:
    modality-probe export [FLAGS] <graph-type> --components <components>... --report <report>

FLAGS:
    -h, --help
            Prints help information
    -i, --interactions-only
            Generate the graph showing only the causal relationships, eliding the events inbetween
    -V, --version
            Prints version information


OPTIONS:
    -c, --components <components>...
            The path to a component directory. To include multiple components, provide this switch
            multiple times
    -r, --report <report>
            The path to the collected trace

ARGS:
    <graph-type>
            The type of graph to output.

            This can be either `cyclic` or `acyclic`. A cyclic graph is one which shows the
            possible paths from either an event or a probe. An acyclic graph shows the causal
            history of either all events or the interactions between probes in the system.
```

Export provides a way to convert your collected trace into a Graphviz
dot graph.


```
$ modality-probe export acyclic \
    --components my-component \
    --report session_8_log_entries.csv > complete.dot
```
### Manifest Generation

```
modality-probe-manifest-gen 0.3.0
Generate component, event and probe manifest files from probe macro invocations

USAGE:
    modality-probe manifest-gen [FLAGS] [OPTIONS] <source-path>

FLAGS:
    -h, --help
            Prints help information
        --regen-component-id
            Regenerate the component IDs instead of using existing IDs (if present)
    -V, --version
            Prints version information

OPTIONS:
        --component-name <component-name>
            Component name used when generating a component manifest [default: component]
        --event-id-offset <event-id-offset>
            Event ID offset, starts at 1 if not specified
        --file-extension <file-extensions>...
            Limit the source code searching to files with matching extensions
    -l, --lang <lang>
            Language (C or Rust), if not specified then guess based on file extensions
    -o, --output-path <output-path>
            Output path where component files are generated [default: component]
        --probe-id-range <probe-id-range>
            Constrain the generated probe ID to an specific range.
            This can be either `<inclusive_start>..<exclusive_end>` or
            `<inclusive_start>..=<inclusive_end>`.
            The range values are unsigned 32-bit integers and must be non-zero.

ARGS:
    <source-path>
            Source code path to search
```

Manifest generation works by exploring your source code looking for
probe initialization and event recordings. It then generates a CSV
file that contains the event name, its autogenerated id, as well as
other metadata about the event. This CSV file then serves two
purposes: generating headers files that contain event and probe
definitions which you can read about in the following section, and
secondly, when interacting with a trace after it’s been collected,
such as with the `export` command, to convert the raw ids back to
human-readable formats.

```
$ modality-probe manifest-gen .
```
### Header Generation

```
modality-probe-header-gen 0.3.0
Generate Rust/C header files with event/probe id constants

USAGE:
    modality-probe header-gen [OPTIONS] <component-path>

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

OPTIONS:
        --include-guard-prefix <include-guard-prefix>
            C header include guard prefix. [default: MODALITY_PROBE]
    -l, --lang <lang>
            The language to output the source in, either `c' or `rust' [default: C]
    -o, --output-path <output-path>
            Write output to file (instead of stdout)

ARGS:
    <component-path>    Component path
```

`header-gen` generates the Rust or C files containing the definitions
for your events and probes. As stated in the previous section, events
and probes, at runtime, use an autogenerated id—an unsigned 32-bit
integer. With `header-gen` you get to use their textual name in your
code, and their name to id mappings are handled through code
generation via this command, and `manifest-gen` before it.

```
$ modality-probe header-gen -o include/probes.h my-component
```

**Note:** you’ll need to run `header-gen` _before_ compilation to give
definitions for those otherwise undefined symbols.

## Running the tests

Use Cargo:

```shell
$ cargo test
```

## License

See [LICENSE](../LICENSE) for more details.
Copyright 2020 Auxon Corporation
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
